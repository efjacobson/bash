#! /bin/bash

if [ "1" != $(git ls-remote --exit-code --heads origin release-next | wc -l) ]; then
  echo "there is no remote release-next, someone forgot to recreate it"
else
  if [ "$1" == "" ]; then
    echo "you must enter a branch name"
  else
    if [[ -n $(git status -s) ]]; then
      echo "clean up the repo bro"
    else
      git branch -D release-next
      git fetch
      git checkout release-next
      git pull origin release-next
      git checkout -b $1
      find "`git rev-parse --show-toplevel`" -name "CHANGELOG.md" -type f -maxdepth 1 -exec sed -i '' -e "1s/^//p; 1s/^.*/$1 todo: update (autogenerated)/" {} +
      git branch -D release-next
    fi
  fi
fi
